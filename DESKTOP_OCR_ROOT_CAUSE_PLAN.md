# 桌面端 OCR 治本提速与稳态增强计划

## 1. 目标与验收

### 1.1 目标
- 仅优化桌面端（`desktop` + `core`），不改 Web。
- 在不更换 PaddleOCR 框架前提下，做架构级提速与稳定性改造。
- 默认保持“平衡优先”，不做全局降质。

### 1.2 验收指标
- 批量任务总耗时下降 ≥ 20%（同机型同数据集）。
- 可恢复错误导致的最终失败数下降 ≥ 50%。
- 输出页数完整率 100%，文本层可搜索性不回退。
- 重试状态、降级原因、失败原因在 UI 可见。

---

## 2. 根因与改造映射

### 2.1 根因 A：进程间数据搬运重
- 现状：主进程 `pix -> numpy -> JPEG`，子进程 `JPEG -> numpy`，每页有编码/解码与复制开销。
- 改造：引入共享内存（SHM）传输，任务只传元数据，降低序列化和拷贝成本。

### 2.2 根因 B：页面处理策略“全量同权”
- 现状：绝大多数页都走完整 OCR 路径。
- 改造：增加轻量页面复杂度预判，低价值页走低成本路径，高价值页维持标准路径。

### 2.3 根因 C：批处理中语言切换频繁
- 现状：语言组合变化导致引擎重建抖动。
- 改造：启动时按语言组合分组，连续处理同组任务。

### 2.4 根因 D：可恢复错误被放大成最终失败
- 现状：失败后常需人工重跑整文件。
- 改造：异常分类 + 自动重试（仅可恢复错误）+ 有界降级兜底。

---

## 3. 实施方案（分阶段）

## 阶段 A：传输链路重构（最高优先级）

### A1 `core/parallel_ocr.py`：扩展任务协议
- 新增 `TransferMode = "auto" | "shm" | "jpeg"`。
- `process_batch()` 支持：
  - SHM payload：`{type, page_num, name, shape, dtype}`
  - JPEG payload：`{type, page_num, bytes}`
- `auto` 默认优先 SHM，失败页级回退 JPEG。

### A2 SHM 生命周期管理
- 主进程：创建、写入、关闭、unlink。
- 子进程：attach、读取、关闭（不 unlink）。
- 批次级 `finally` 强制清理，防泄漏。
- 增加本进程资源注册表用于异常收口清理。

### A3 回退与容错
- SHM attach/read 失败时，单页重投 JPEG，不整批失败。
- 单页重投上限默认 1 次，超限后记页失败并继续。

## 阶段 B：页面级智能调度（第二优先级）

### B1 轻量预判器（无新模型依赖）
- 在渲染线程对缩小图提取低成本特征：
  - 边缘密度
  - 连通域数量
  - 文本形态比率
- 输出 `page_complexity_score`（低/中/高）。

### B2 动态路径选择（平衡优先）
- 高复杂页：保持标准路径（当前 DPI + balanced）。
- 低复杂页：仅该页降成本（如降 1 档 DPI 或 fast）。
- 不做全局降级。

### B3 质量防护
- 若低复杂页 OCR 文本量异常偏少，触发一次补识别（标准路径）。

## 阶段 C：批处理调度与重试体系（第三优先级）

### C1 `desktop/main_window.py`：任务分组
- 启动处理前按 `tuple(languages)` 稳定排序分组。
- 同组内保持添加顺序。

### C2 `desktop/workers.py`：异常分类器
- 分类为：
  - `non_retryable`：用户取消、输入损坏、权限错误等
  - `retryable`：超时、子进程中断、临时 I/O 或内存压力等
- 仅 `retryable` 触发自动重试。

### C3 有界重试与降级
- 默认 `max_retries=2`（总尝试 3 次）。
- 尝试策略：
  1. 原参数
  2. 强制单进程
  3. 单进程 + 关闭页级调度（排除误判）+ 适度降档
- 用户主动停止时，不进入重试。

## 阶段 D：可观测性与反馈

### D1 UI 状态
- 新增状态文案：
  - `重试中 (n/N)`
  - `降级重试：单进程/补识别`
- 任务完成后保留重试摘要与降级摘要。

### D2 统计与日志
- 完成弹窗新增：
  - 重试成功文件数
  - 降级成功文件数
- 调试日志结构化字段：
  - `transfer_mode`
  - `fallback_count`
  - `retry_count`
  - `page_reinfer_count`
  - `elapsed_per_page`

---

## 4. 风险漏洞审计与补丁

### 4.1 SHM 泄漏风险
- 风险：异常路径遗漏 unlink 导致内存泄漏。
- 补丁：统一资源注册 + 批次 finally 清理 + 退出前兜底清理。

### 4.2 跨平台 spawn 差异
- 风险：Windows/macOS 下多进程序列化边界不同。
- 补丁：payload 仅使用基础可序列化类型（dict/tuple/str/int/list）。

### 4.3 预判误判导致漏识别
- 风险：低复杂页被过度降级。
- 补丁：文本量异常页触发一次补识别。

### 4.4 重试风暴
- 风险：错误分类过宽导致无效重试反而更慢。
- 补丁：白名单式 retryable + 指数退避上限 + 同类错误短路。

### 4.5 分组调度改变用户预期顺序
- 风险：用户希望严格按添加顺序。
- 补丁：增加配置开关 `batch/group_by_language`（默认开，可关闭）。

---

## 5. 接口与配置变更

### 5.1 新增 QSettings 键
- `performance/transfer_mode`: `auto|shm|jpeg`（默认 `auto`）
- `performance/auto_retry_enabled`: `true`
- `performance/max_retries`: `2`
- `batch/group_by_language`: `true`

### 5.2 兼容策略
- 旧版本无键值时自动使用默认值。
- 历史 `num_workers > 2` 自动钳制到 `2`，并记录迁移日志。

---

## 6. 测试计划

### 6.1 单元测试
- SHM/JPEG payload 编解码一致性。
- 异常分类器判定准确性。
- 重试状态机（次数、停止条件、降级顺序）。

### 6.2 集成测试
- 20 页、200 页、混合语言批处理。
- 人工注入：SHM attach 失败、子进程崩溃、超时、低内存。
- 校验输出页数、文本层、任务状态一致性。

### 6.3 性能基准
- 数据集 A（普通文档）、B（图像重）、C（低文本密度）。
- 指标：总耗时、平均每页、P95 页耗时、最终失败数。

### 6.4 回归测试
- 用户取消流程。
- 断点续传。
- 导出 txt/md。
- 完成弹窗与警告展示。

---

## 7. 发布与回滚

### 7.1 灰度策略
- 首发默认 `transfer_mode=auto`，保留一键切回 `jpeg`。
- 重点观察：失败率、P95 耗时、SHM 回退率。

### 7.2 回滚策略
- 若某平台异常上升：配置级切回 `jpeg + 关闭页级调度`，无需回滚版本。

---

## 8. 本期边界
- 不更换 OCR 框架（ONNX/TensorRT 不纳入本期）。
- 不改 Web API 链路。
- 不做 GPU 推理架构迁移（保留现有兼容逻辑）。

---

## 9. 锁定默认决策
- 仅桌面端改造。
- 平衡优先，不做全局降质。
- 中等改造，不换模型后端。
- 自动重试仅用于可恢复错误。
- 并发上限控制在 2，优先稳定吞吐。
